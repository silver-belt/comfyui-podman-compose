version: "3.9"

services:
  comfyui:
    image: comfyui:latest
    container_name: comfyui
    build:
      context: .
      dockerfile: dockerfile
    user: "1000:1000"
    devices:
      - "nvidia.com/gpu=all"      # Podman CDI hook hands over the NVIDIA GPU
    security_opt:
      - label=disable             # Needed on SELinux hosts (ignored elsewhere)
    expose:
      - "8188"
    volumes:
      - ./custom_nodes:/workspace/custom_nodes
      - ./models:/workspace/models
      - ./output:/workspace/output
      - ./venv:/opt/venv
    tmpfs:
      - /workspace/input:size=1G,mode=1777
      - /workspace/temp:size=1G,mode=1777
    deploy:
      resources:
        limits:
          memory: 40g          # hard limit
          cpus: "8.0"
        reservations:
          memory: 35g           # OOM-Killer earlier
          devices:
            - driver: nvidia
              count: 1
              capabilities:
                - gpu           # Docker alternative to runtime: nvidia + NVIDIA_VISIBLE_DEVICES
    restart: "no"

  proxy:
    image: nginx:alpine
    container_name: comfyui-proxy
    depends_on:
      - comfyui
    ports:
      - "8443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro,Z
      - ./nginx/htpasswd:/etc/nginx/htpasswd:ro,Z
      - ./nginx/certs:/etc/nginx/certs:ro,Z
